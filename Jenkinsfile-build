pipeline {
    agent any
    
    parameters {
        booleanParam(
            name: 'RUN_TESTS',
            defaultValue: false,
            description: 'Run unit and UI tests before building the image. Set to false to skip tests and build faster.'
        )
    }
    
    environment {
        REGISTRY = "harbor.arpansahu.space"
        REPOSITORY = "library/chew_and_cheer"
        IMAGE_TAG = "${env.BUILD_ID}"
        ENV_PROJECT_NAME = "chew_and_cheer"
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Setup Environment') {
            steps {
                script {
                    withCredentials([file(credentialsId: 'chew_and_cheer_env', variable: 'ENV_FILE')]) {
                        sh "cp \$ENV_FILE .env"
                        echo '.env file created successfully from credentials'
                    }
                }
            }
        }
        stage('Run Tests') {
            when {
                expression { params.RUN_TESTS == true }
            }
            steps {
                script {
                    echo 'Running Django Unit Tests...'
                    
                    // Run unit tests in Docker container
                    sh """
                    docker run --rm \
                        -v \$(pwd):/app \
                        -w /app \
                        --env-file .env \
                        python:3.10.7 \
                        bash -c 'pip install -q -r requirements.txt && \
                                 python manage.py test --verbosity=2 --failfast'
                    """
                    
                    echo '‚úÖ All unit tests passed successfully!'
                }
            }
        }
        stage('Service Health Check') {
            when {
                expression { params.RUN_TESTS == true }
            }
            steps {
                script {
                    echo 'Running Service Health Checks...'
                    
                    // Run service health checks in Docker container
                    sh """
                    docker run --rm \
                        -v \$(pwd):/app \
                        -w /app \
                        --env-file .env \
                        python:3.10.7 \
                        bash -c 'pip install -q -r requirements.txt && \
                                 python manage.py test_db && \
                                 python manage.py test_cache && \
                                 python manage.py test_storage && \
                                 python manage.py test_email --detailed'
                    """
                    
                    echo '‚úÖ All service health checks passed!'
                }
            }
        }
        stage('Tests Status') {
            steps {
                script {
                    if (params.RUN_TESTS) {
                        echo '‚úÖ Tests were executed in previous stages'
                    } else {
                        echo '‚ö†Ô∏è  Tests skipped - RUN_TESTS parameter is set to false'
                        echo 'üí° To run tests, set RUN_TESTS=true when triggering the build'
                    }
                }
            }
        }
        stage('Build Image') {
            steps {
                script {
                    // Ensure Docker is running and can be accessed
                    sh 'docker --version'

                    // Log the image details
                    echo "Building Docker image: ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG}"

                    // Build the Docker image
                    sh """
                    docker build -t ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG} .
                    docker tag ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG} ${REGISTRY}/${REPOSITORY}:latest
                    """
                }
            }
        }
        stage('Push Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'harbor-credentials', passwordVariable: 'DOCKER_REGISTRY_PASSWORD', usernameVariable: 'DOCKER_REGISTRY_USERNAME')]) {
                    script {
                        // Log in to Docker registry using environment variables without direct interpolation
                        sh '''
                        echo $DOCKER_REGISTRY_PASSWORD | docker login ${REGISTRY} -u $DOCKER_REGISTRY_USERNAME --password-stdin
                        '''

                        // Push the Docker image to the registry
                        sh '''
                        docker push ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG}
                        docker push ${REGISTRY}/${REPOSITORY}:latest
                        '''
                    }
                }
            }
        }
    }
    post {
        success {
            script {
                if (!currentBuild.description) {
                    currentBuild.description = "Image: ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG} built and pushed successfully"
                }
                
                // Send success notification email
                sh """curl -s \
                -X POST \
                --user $MAIL_JET_API_KEY:$MAIL_JET_API_SECRET \
                https://api.mailjet.com/v3.1/send \
                -H "Content-Type:application/json" \
                -d '{
                    "Messages":[
                            {
                                    "From": {
                                            "Email": "$MAIL_JET_EMAIL_ADDRESS",
                                            "Name": "ArpanSahuOne Jenkins Notification"
                                    },
                                    "To": [
                                            {
                                                    "Email": "$MY_EMAIL_ADDRESS",
                                                    "Name": "Development Team"
                                            }
                                    ],
                                    "Subject": "${currentBuild.description}",
                                    "TextPart": "Hola Development Team, your project ${currentBuild.fullDisplayName} : ${currentBuild.description}",
                                    "HTMLPart": "<h3>Hola Development Team, your project ${currentBuild.fullDisplayName} : ${currentBuild.description} </h3> <br> <p> Build Url: ${env.BUILD_URL}  </p>"
                            }
                    ]
                }'"""
            }
        }
        failure {
            script {
                // Send failure notification email
                sh """curl -s \
                -X POST \
                --user $MAIL_JET_API_KEY:$MAIL_JET_API_SECRET \
                https://api.mailjet.com/v3.1/send \
                -H "Content-Type:application/json" \
                -d '{
                    "Messages":[
                            {
                                    "From": {
                                            "Email": "$MAIL_JET_EMAIL_ADDRESS",
                                            "Name": "ArpanSahuOne Jenkins Notification"
                                    },
                                    "To": [
                                            {
                                                    "Email": "$MY_EMAIL_ADDRESS",
                                                    "Name": "Development Team"
                                            }
                                    ],
                                    "Subject": "${currentBuild.fullDisplayName} build failed",
                                    "TextPart": "Hola Development Team, your project ${currentBuild.fullDisplayName} build failed ${currentBuild.description} ",
                                    "HTMLPart": "<h3>Hola Development Team, your project ${currentBuild.fullDisplayName} build failed </h3> <br> <p> ${currentBuild.description}  </p>"
                            }
                    ]
                }'"""
            }
        }
    }
}