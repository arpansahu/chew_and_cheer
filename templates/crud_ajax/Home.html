{% extends 'crud_ajax/base.html' %}
{% load static %}
{% block content %}

<style>
    .crud-container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 0 20px;
    }
    
    .page-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
    }
    
    .card-custom {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .card-header-custom {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 1.3rem;
        font-weight: 600;
    }
    
    .form-control {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .table-custom {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .table-custom thead {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .table-custom thead th {
        border: none;
        padding: 15px;
        font-weight: 600;
    }
    
    .table-custom tbody tr {
        transition: all 0.2s ease;
    }
    
    .table-custom tbody tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.01);
    }
    
    .table-custom tbody td {
        padding: 15px;
        vertical-align: middle;
    }
    
    .action-btn {
        padding: 8px 15px;
        border-radius: 6px;
        font-size: 0.9rem;
        min-width: 80px;
        margin: 2px;
    }
    
    .modal-header-custom {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 0;
    }
    
    .modal-header-custom .close {
        color: white;
        opacity: 1;
    }
</style>

<div class="crud-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1><i class="fas fa-bolt"></i> CRUD Operations - AJAX/Class Views</h1>
        <p class="mb-0">Real-time menu management with asynchronous JavaScript and XML</p>
    </div>

    <div class="row">
        <!-- Add New Item Form -->
        <div class="col-lg-4 col-md-12">
            <div class="card-custom">
                <div class="card-header-custom">
                    <i class="fas fa-plus-circle"></i> Add New Item
                </div>
                <form id="addItem" action="">
                    <div class="form-group">
                        <label class="font-weight-bold"><i class="fas fa-utensils"></i> Item Name</label>
                        <input class="form-control" type="text" name="name" placeholder="Enter item name" required>
                    </div>
                    <div class="form-group">
                        <label class="font-weight-bold"><i class="fas fa-align-left"></i> Description</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Enter description" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="font-weight-bold"><i class="fas fa-dollar-sign"></i> Price ($)</label>
                        <input class="form-control" type="number" name="price" step="0.01" placeholder="0.00" required>
                    </div>
                    <button class="btn btn-success btn-block" type="submit" style="border-radius: 8px; padding: 12px; font-weight: 600;">
                        <i class="fas fa-save"></i> Add Item
                    </button>
                </form>
            </div>
        </div>

        <!-- Items List -->
        <div class="col-lg-8 col-md-12">
            <div class="card-custom">
                <div class="card-header-custom">
                    <i class="fas fa-list"></i> Menu Items
                </div>

                {% if items %}
                    <div class="table-responsive">
                        <table id="itemsTable" class="table table-custom">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr id="item-{{item.id}}">
                                    <td><strong>#{{ item.id }}</strong></td>
                                    <td class="itemName itemData" name="name"><strong>{{ item.name }}</strong></td>
                                    <td class="itemDescription itemData" name="description">{{ item.description }}</td>
                                    <td class="itemPrice itemData" name="price"><span class="badge badge-success">${{ item.price }}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-success action-btn" onClick="editItem({{item.id}})" data-toggle="modal" data-target="#myModal">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-danger action-btn" onClick="deleteItem({{item.id}})" data-toggle="modal" data-target="#deleteModal">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Delete operations can only be performed by Admin users.
                    </div>
                {% else %}
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <h4>No Items Found</h4>
                        <p>Start by adding your first menu item using the form on the left.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Update Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h4 class="modal-title" id="myModalLabel"><i class="fas fa-edit"></i> Update Item</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <form id="updateItem" action="">
                    <div class="modal-body">
                        <input class="form-control" id="form-id" type="hidden" name="formId"/>
                        
                        <div class="form-group">
                            <label for="form-name" class="font-weight-bold"><i class="fas fa-utensils"></i> Item Name</label>
                            <input class="form-control" id="form-name" type="text" name="formName" placeholder="Enter item name" required/>
                        </div>
                        
                        <div class="form-group">
                            <label for="form-description" class="font-weight-bold"><i class="fas fa-align-left"></i> Description</label>
                            <textarea class="form-control" id="form-description" name="formDescription" rows="3" placeholder="Enter description" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="form-price" class="font-weight-bold"><i class="fas fa-dollar-sign"></i> Price ($)</label>
                            <input class="form-control" id="form-price" type="number" step="0.01" name="formPrice" placeholder="0.00" required/>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header modal-header-custom bg-danger">
                    <h4 class="modal-title" id="deleteModalLabel"><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <form id="deleteItem" action="">
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Warning!</strong> This action cannot be undone.
                        </div>
                        <p class="mb-0">Are you sure you want to delete this item?</p>
                        <input class="form-control" id="delete-form-id" type="hidden" name="deleteformId" />
                        <input class="form-control" id="delete-form-name" type="hidden" name="deleteformName" />
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete Item
                        </button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block javascript %}
<script>


// Create Django Ajax Call
    $("form#addItem").submit(function() {
        var name = $('input[name="name"]').val().trim();
        var description = $('input[name="description"]').val().trim();
        var price = $('input[name="price"]').val().trim();
        if (name && description && price) {
            // Create Ajax Call
            $.ajax({
                url: '{% url "crud_ajax_create" %}',
                data: {
                    'name': name,
                    'description': description,
                    'price': price
                },
                dataType: 'json',
                success: function (data) {
                    if (data.item) {
                      appendToItemTable(data.item);
                    }
                }
            });
          } else {
            alert("All fields must have a valid value.");
        }
        $('form#addItem').trigger("reset");
        return false;
    });
    function appendToItemTable(item) {
      $("#itemsTable > tbody:last-child").append(`
            <tr id="item-${item.id}">
                <td><strong>#${item.id}</strong></td>
                <td class="itemName itemData" name="name"><strong>${item.name}</strong></td>
                <td class="itemDescription itemData" name="description">${item.description}</td>
                <td class="itemPrice itemData" name="price"><span class="badge badge-success">$${item.price}</span></td>
                <td>
                    <button class="btn btn-sm btn-success action-btn" onClick="editItem(${item.id})" data-toggle="modal" data-target="#myModal">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger action-btn" onClick="deleteItem(${item.id})" data-toggle="modal" data-target="#deleteModal">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `);
    }


    $("form#updateItem").submit(function() {
        var id = $('input[name="formId"]').val().trim();
        var name = $('input[name="formName"]').val().trim();
        var description = $('input[name="formDescription"]').val().trim();
        var price = $('input[name="formPrice"]').val().trim();
        if (name && description && price) {
            // Create Ajax Call
            $.ajax({
                url: '{% url "crud_ajax_update" %}',
                data: {
                    'id': id,
                    'name': name,
                    'description': description,
                    'price': price
                },

                dataType: 'json',
                success: function (data) {
                    if (data.item) {
                      updateToItemTable(data.item);
                    }
                }
            });
           } else {
            alert("All fields must have a valid value.");
        }
        $('form#updateItem').trigger("reset");
        $('#myModal').modal('hide');
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        return false;
    });

    // Update Django Ajax Call
    function editItem(id) {
      if (id) {
        tr_id = "#item-" + id;
        name = $(tr_id).find(".itemName").text();
        description = $(tr_id).find(".itemDescription").text();
        price = $(tr_id).find(".itemPrice").text();
        $('#form-id').val(id);
        $('#form-name').val(name);
        $('#form-description').val(description);
        $('#form-price').val(price);
      }
    }

    function updateToItemTable(item){
        $("#itemsTable #item-" + item.id).children(".itemData").each(function() {
            var name = $(this).attr("name");

            if (name == "name") {
              $(this).text(item.name);
            } else if (name == "description") {
              $(this).text(item.description);
            } else {
              $(this).text(item.price);
            }
          });
    }

    // Delete Django Ajax Call
    function deleteItem(id) {
      if (id) {
        tr_id = "#item-" + id;
        name = $(tr_id).find(".itemName").text();

        $('#delete-form-id').val(id);
        $('#delete-form-name').val(name);

      }
    }

    $("form#deleteItem").submit(function() {
        var id = $('input[name="deleteformId"]').val().trim();

        if (id) {
            // Create Ajax Call
            $.ajax({
                url: '{% url "crud_ajax_delete" %}',
                data: {
                    'id': id,
                },

                dataType: 'json',
                success: function (data) {
                    if (data.deleted) {
                  $("#itemsTable #item-" + id).remove();
                }
                }
            });
           } else {
            alert("All fields must have a valid value.");
        }
        $('form#deleteItem').trigger("reset");
        $('#deleteModal').modal('hide');
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();

        return false;
    });
</script>
{% endblock javascript %}